<!DOCTYPE html>
<html lang="en">
    <head>
        
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <meta name="description" content="Ed On Code is a blog about software development and related topics.">
        

        <title>Ed On Code</title>

        
            <link rel="stylesheet" href="https://edoncode.dev/theme.css">
        
        
    </head>
    <body>
        <div class="content">
        
        
            <header>
                <div class="header-left">
                    <a href="https://edoncode.dev" class="logo">Ed On Code</a>
                </div>
                <div class="header-right">
                    <nav itemscope itemtype="http://schema.org/SiteNavigationElement">
                      <ul>
                        
                        
                            
                            <li class="nav">
                                <a itemprop="url" href="https://edoncode.dev/Adventures/">
                                    <span itemprop="name">Adventures</span>
                                </a>
                            </li>
                        
                            
                            <li class="nav">
                                <a itemprop="url" href="https://edoncode.dev/Golang/">
                                    <span itemprop="name">Golang</span>
                                </a>
                            </li>
                        
                            
                            <li class="nav">
                                <a itemprop="url" href="https://edoncode.dev/Tech/">
                                    <span itemprop="name">Tech</span>
                                </a>
                            </li>
                        
                            
                            <li class="nav">
                                <a itemprop="url" href="https://edoncode.dev/Thoughts/">
                                    <span itemprop="name">Thoughts</span>
                                </a>
                            </li>
                        
                        
                        <li class="nav">
                            <a itemprop="url" href="https://github.com/eduardonunesp">
                                <img class="icon" src="https://edoncode.dev/icons/github.svg" alt="Github">
                            </a>
                        </li>
                        
                        
                      </ul>
                    </nav>
                </div>
            </header>
        
        
        <main>
            
<article itemscope itemtype="http://schema.org/BlogPosting">
    <div itemprop="headline">
        <h1>Real Time Volume-Weighted Average Price</h1>
        <div class="border"></div>
        <time datetime="2023-10-13" class="date" itemprop="datePublished">
            13 Oct 2023
        </time>
    </div>
    <div itemprop="articleBody">
        
    <ul>
    
        <li>
            <a href="https://edoncode.dev/Golang/rtvwap/#First_what_is_VWAP?">First what is VWAP?</a>
            
        </li>
    
        <li>
            <a href="https://edoncode.dev/Golang/rtvwap/#Creating_the_trading_structures">Creating the trading structures</a>
            
        </li>
    
        <li>
            <a href="https://edoncode.dev/Golang/rtvwap/#Creating_the_VWAP_calculator">Creating the VWAP calculator</a>
            
        </li>
    
        <li>
            <a href="https://edoncode.dev/Golang/rtvwap/#Getting_the_trades_from_the_provider">Getting the trades from the provider</a>
            
        </li>
    
        <li>
            <a href="https://edoncode.dev/Golang/rtvwap/#Putting_it_all_together">Putting it all together</a>
            
        </li>
    
        <li>
            <a href="https://edoncode.dev/Golang/rtvwap/#Conclusion">Conclusion</a>
            
        </li>
    
    </ul>

        <p>Today I'm going to talk about an analysis indicator know as Volume-Weighted Average Price. In the fast-paced world of financial markets, traders are constantly on the lookout for tools and strategies to help them make informed decisions.</p>
<p>One such tool that has gained significant popularity over the years is the Volume-Weighted Average Price (VWAP). VWAP is more than just an indicator; it's a powerful concept that traders use to gain insights into market dynamics, execute orders effectively, and improve their trading strategies. In this blog post, we will delve into what VWAP is, how it works and create our own in Go.</p>
<h2 id="First_what_is_VWAP?">First what is VWAP?</h2>
<p>Volume-Weighted Average Price (VWAP) is a trading indicator that provides a benchmark price for a particular security over a given time period, typically a trading day. Unlike traditional moving averages, VWAP takes into account both the price and the volume of trades. In essence, VWAP calculates the average price at which a security has traded throughout the day, weighted by the volume of those trades. It's calculated using the following formula:</p>
<div style="background: white; margin: auto; width: 20%">
<img src="https://wikimedia.org/api/rest_v1/media/math/render/svg/6c0a822a0a9e58a127105e818a07061a02851685" />
</div>
<h2 id="Creating_the_trading_structures">Creating the trading structures</h2>
<p>So first lets create the structures that we will use to represent the trades and the VWAP result. We will also create an interface that all trade providers must implement. This will allow us to create a VWAP calculator that can be used with any trade provider.</p>
<pre data-lang="go" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-go "><code class="language-go" data-lang="go"><span style="color:#608b4e;">// TradeChannel is the channel is used to receive trades from the provider
</span><span style="color:#569cd6;">type </span><span style="color:#4ec9b0;">TradeChannel </span><span style="color:#569cd6;">chan Trade
</span><span>
</span><span style="color:#608b4e;">// TradePair is the representation of the trading pair left and right pairs
</span><span style="color:#608b4e;">// For instance ETH-USD, BTC-USD, USD-ETH
</span><span style="color:#569cd6;">type </span><span style="color:#4ec9b0;">TradePair </span><span style="color:#569cd6;">struct </span><span>{
</span><span>	From string
</span><span>	To   string
</span><span>}
</span><span>
</span><span style="color:#608b4e;">// Trade represents a trade that matched/closed on the provider
</span><span style="color:#569cd6;">type </span><span style="color:#4ec9b0;">Trade </span><span style="color:#569cd6;">struct </span><span>{
</span><span>	TradePair </span><span style="color:#569cd6;">TradePair
</span><span>	Price     </span><span style="color:#569cd6;">*</span><span>big.</span><span style="color:#569cd6;">Float
</span><span>	Quantity  </span><span style="color:#569cd6;">*</span><span>big.</span><span style="color:#569cd6;">Float
</span><span>}
</span><span>
</span><span style="color:#608b4e;">// VWAPResult serves as a container for the result of a VWAP calculation
</span><span style="color:#569cd6;">type </span><span style="color:#4ec9b0;">VWAPResult </span><span style="color:#569cd6;">struct </span><span>{
</span><span>	Pair      </span><span style="color:#569cd6;">TradePair
</span><span>	VWAPValue </span><span style="color:#569cd6;">*</span><span>big.</span><span style="color:#569cd6;">Float
</span><span>}
</span><span>
</span><span>
</span><span style="color:#608b4e;">// TradeProvider is the core interface that all trade providers must implement
</span><span style="color:#569cd6;">type </span><span style="color:#4ec9b0;">TradeProvider </span><span style="color:#569cd6;">interface </span><span>{
</span><span>	GetTradeChannel(pair </span><span style="color:#569cd6;">TradePair</span><span>) (</span><span style="color:#569cd6;">TradeChannel</span><span>, error)
</span><span>}
</span></code></pre>
<h2 id="Creating_the_VWAP_calculator">Creating the VWAP calculator</h2>
<p>Now that we have the structures in place we can create the VWAP calculator. The calculator will take a trade provider and a trade pair and return a channel that will be used to receive the VWAP result.</p>
<pre data-lang="go" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-go "><code class="language-go" data-lang="go"><span style="color:#608b4e;">// We&#39;re going to omit the imports and other boilerplate code for brevity
</span><span>
</span><span style="color:#608b4e;">// Calculate runs the VWAP calculation and send the resut to a chan of thep VWAP result
</span><span style="color:#608b4e;">// The VWAP has the realtime calculations
</span><span style="color:#569cd6;">func </span><span>(vwap </span><span style="color:#569cd6;">*VWAP</span><span>) Calculate(vwapResultChan </span><span style="color:#569cd6;">chan&lt;- VWAPResult</span><span>) {
</span><span>	</span><span style="color:#569cd6;">go func</span><span>() {
</span><span>	outloop:
</span><span>		</span><span style="color:#569cd6;">for </span><span>{
</span><span>			</span><span style="color:#569cd6;">select </span><span>{
</span><span>			</span><span style="color:#569cd6;">case &lt;-</span><span>vwap.ctx.Done():
</span><span>				</span><span style="color:#569cd6;">break </span><span>outloop
</span><span>			</span><span style="color:#569cd6;">case </span><span>trade, ok := </span><span style="color:#569cd6;">&lt;-</span><span>vwap.tradeChan:
</span><span>				</span><span style="color:#569cd6;">if !</span><span>ok {
</span><span>					</span><span style="color:#569cd6;">break </span><span>outloop
</span><span>				}
</span><span>				vwap.tradeSamples.PushBack(trade)
</span><span>
</span><span>				</span><span style="color:#608b4e;">// Keep max of queue buffer size or 200 samples
</span><span>				</span><span style="color:#569cd6;">for </span><span>vwap.tradeSamples.Len() </span><span style="color:#569cd6;">&gt; </span><span>queueBufferSize {
</span><span>					e := vwap.tradeSamples.Front()
</span><span>					vwap.tradeSamples.Remove(e)
</span><span>				}
</span><span>
</span><span>				</span><span style="color:#608b4e;">// PV = Σ(Price * Volume)
</span><span>				sumPriceAndVolume := new(big.</span><span style="color:#569cd6;">Float</span><span>)
</span><span>				</span><span style="color:#569cd6;">for </span><span>e := vwap.tradeSamples.Front(); e </span><span style="color:#569cd6;">!= nil</span><span>; e = e.Next() {
</span><span>					priceAndVolume := new(big.</span><span style="color:#569cd6;">Float</span><span>).Mul(e.Value.(</span><span style="color:#569cd6;">Trade</span><span>).Price, e.Value.(</span><span style="color:#569cd6;">Trade</span><span>).Quantity)
</span><span>					sumPriceAndVolume = new(big.</span><span style="color:#569cd6;">Float</span><span>).Add(sumPriceAndVolume, priceAndVolume)
</span><span>				}
</span><span>
</span><span>				</span><span style="color:#608b4e;">// SV = ΣVolume
</span><span>				sumVolume := new(big.</span><span style="color:#569cd6;">Float</span><span>)
</span><span>				</span><span style="color:#569cd6;">for </span><span>e := vwap.tradeSamples.Front(); e </span><span style="color:#569cd6;">!= nil</span><span>; e = e.Next() {
</span><span>					sumVolume = new(big.</span><span style="color:#569cd6;">Float</span><span>).Add(sumVolume, e.Value.(</span><span style="color:#569cd6;">Trade</span><span>).Quantity)
</span><span>				}
</span><span>
</span><span>				</span><span style="color:#608b4e;">// VWP = PV / SV
</span><span>				result := VWAPResult{
</span><span>					Pair:      trade.TradePair,
</span><span>					VWAPValue: new(big.</span><span style="color:#569cd6;">Float</span><span>).Quo(sumPriceAndVolume, sumVolume),
</span><span>				}
</span><span>
</span><span>				vwapResultChan </span><span style="color:#569cd6;">&lt;- </span><span>result
</span><span>			}
</span><span>		}
</span><span>	}()
</span><span>}
</span></code></pre>
<h2 id="Getting_the_trades_from_the_provider">Getting the trades from the provider</h2>
<p>Now that we have the VWAP calculator we need to get the trades from the provider. For this example we will use the <a href="https://docs.cloud.coinbase.com/exchange/docs/websocket-overview">Coinbase Pro Websocket API</a> to get the trades in realtime. We will create a function that will get the trades from the provider and send them to the VWAP calculator.</p>
<pre data-lang="go" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-go "><code class="language-go" data-lang="go"><span style="color:#608b4e;">// We&#39;re going to omit the imports and other boilerplate code for brevity
</span><span>
</span><span style="color:#608b4e;">// CreateTradeProvider will return the TradeProvider ready to use with a go channel ready to consume
</span><span style="color:#569cd6;">func </span><span>(c </span><span style="color:#569cd6;">coinbaseProvider</span><span>) GetTradeChannel(pair internals.</span><span style="color:#569cd6;">TradePair</span><span>) (internals.</span><span style="color:#569cd6;">TradeChannel</span><span>, error) {
</span><span>	</span><span style="color:#608b4e;">// Connect to the websocket API 
</span><span>	wsConn, err := newCoinbaseWS()
</span><span>	</span><span style="color:#569cd6;">if </span><span>err </span><span style="color:#569cd6;">!= nil </span><span>{
</span><span>		</span><span style="color:#569cd6;">return nil</span><span>, ErrFailedToConnect
</span><span>	}
</span><span>
</span><span>	</span><span style="color:#608b4e;">// Subscribe to the match channel
</span><span>	</span><span style="color:#569cd6;">if </span><span>err := subscribeToMatchChannel(wsConn, pair.String()); err </span><span style="color:#569cd6;">!= nil </span><span>{
</span><span>		</span><span style="color:#569cd6;">return nil</span><span>, ErrFailedToSubscribe
</span><span>	}
</span><span>
</span><span>	tradeChan := make(internals.</span><span style="color:#569cd6;">TradeChannel</span><span>)
</span><span>
</span><span>	</span><span style="color:#569cd6;">go func</span><span>() {
</span><span>		</span><span style="color:#569cd6;">defer </span><span>close(tradeChan)
</span><span>		</span><span style="color:#569cd6;">defer </span><span>wsConn.Close()
</span><span>
</span><span>		</span><span style="color:#569cd6;">var </span><span>errCounter int
</span><span>
</span><span>	outerloop:
</span><span>		</span><span style="color:#569cd6;">for </span><span>{
</span><span>			</span><span style="color:#569cd6;">select </span><span>{
</span><span>			</span><span style="color:#569cd6;">case &lt;-</span><span>c.ctx.Done():
</span><span>				</span><span style="color:#569cd6;">break </span><span>outerloop
</span><span>			</span><span style="color:#569cd6;">default</span><span>:
</span><span>				</span><span style="color:#608b4e;">// Get the response from the websocket
</span><span>				price, quantity, err := matchResponse(wsConn)
</span><span>				</span><span style="color:#569cd6;">if </span><span>err </span><span style="color:#569cd6;">!= nil &amp;&amp; </span><span>errors.Is(err, errNonExpectedMessage) {
</span><span>					</span><span style="color:#569cd6;">continue
</span><span>				} </span><span style="color:#569cd6;">else if </span><span>err </span><span style="color:#569cd6;">!= nil </span><span>{
</span><span>					</span><span style="color:#569cd6;">if </span><span>errCounter &gt;= ErrCounterThreshold {
</span><span>						</span><span style="color:#569cd6;">break </span><span>outerloop
</span><span>					}
</span><span>					</span><span style="color:#569cd6;">continue
</span><span>				}
</span><span>				errCounter = </span><span style="color:#b5cea8;">0
</span><span>
</span><span>				</span><span style="color:#608b4e;">// Only accept with price and quantity ok
</span><span>				</span><span style="color:#569cd6;">if </span><span>price </span><span style="color:#569cd6;">== nil &amp;&amp; </span><span>quantity </span><span style="color:#569cd6;">== nil </span><span>{
</span><span>					</span><span style="color:#569cd6;">continue
</span><span>				}
</span><span>
</span><span>				</span><span style="color:#608b4e;">// New trade ready to push into go channel
</span><span>				tradeChan </span><span style="color:#569cd6;">&lt;- </span><span>internals.NewTrade(pair, price, quantity)
</span><span>			}
</span><span>		}
</span><span>	}()
</span><span>
</span><span>	</span><span style="color:#569cd6;">return </span><span>tradeChan, </span><span style="color:#569cd6;">nil
</span><span>}
</span></code></pre>
<h2 id="Putting_it_all_together">Putting it all together</h2>
<p>Now that we have the VWAP calculator and the trade provider we can put it all together. We will create a main function that will create the VWAP calculator and the trade provider. Then we will run the VWAP calculator and print the results to the console.</p>
<pre data-lang="go" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-go "><code class="language-go" data-lang="go"><span style="color:#608b4e;">// We&#39;re going to omit the imports and other boilerplate code for brevity
</span><span>
</span><span style="color:#569cd6;">func </span><span>main() {
</span><span>	ctx, cancel := context.WithCancel(context.Background())
</span><span>	vwapResultChan := createResultChan()
</span><span>
</span><span>	pair := internals.NewTradePair(</span><span style="color:#d69d85;">&quot;BTC&quot;</span><span>, </span><span style="color:#d69d85;">&quot;USD&quot;</span><span>)
</span><span>	provider := tradeproviders.NewCoinbaseProvider(ctx)
</span><span>
</span><span>	tradeChan, err := provider.GetTradeChannel(pair)
</span><span>	</span><span style="color:#569cd6;">if </span><span>err </span><span style="color:#569cd6;">!= nil </span><span>{
</span><span>		panic(err)
</span><span>	}
</span><span>
</span><span>	internals.NewVWAP(ctx, tradeChan).Calculate(vwapResultChan)
</span><span>
</span><span>	</span><span style="color:#569cd6;">for </span><span>{
</span><span>		</span><span style="color:#569cd6;">select </span><span>{
</span><span>		</span><span style="color:#569cd6;">case </span><span>result := </span><span style="color:#569cd6;">&lt;-</span><span>vwapResultChan:
</span><span>			fmt.Printf(</span><span style="color:#d69d85;">&quot;VWAP RESULT </span><span style="color:#b4cea8;">%s %f</span><span style="color:#e3bbab;">\n</span><span style="color:#d69d85;">&quot;</span><span>, result.Pair.String(), result.VWAPValue)
</span><span>		</span><span style="color:#569cd6;">case &lt;-</span><span>waitSIGINT():
</span><span>			cancel()
</span><span>			close(vwapResultChan)
</span><span>			os.Exit(</span><span style="color:#b5cea8;">0</span><span>)
</span><span>		}
</span><span>	}
</span><span>}
</span></code></pre>
<h2 id="Conclusion">Conclusion</h2>
<p>In this blog post we have created a VWAP calculator that can be used with any trade provider. We have also created a trade provider that uses the Coinbase Pro Websocket API to get the trades in realtime. We have put it all together and printed the results to the console. I hope you have enjoyed this blog post and learned something new.</p>
<p>This code can be found at my <a href="https://github.com/eduardonunesp/rtvwap">GitHub://eduardonunesp/rtvwap</a></p>

    </div>
</article>

        </main>
        
        <footer>
            
            <div class="border"></div>
            <div class="footer">
                <small class="footer-left">
                    Copyright &copy; Eduardo Pereira
                </small>
                <small class="footer-right">
                    Powered by <a href="https://www.getzola.org">Zola</a> | Theme <a href="https://github.com/barlog-m/oceanic-zen">Oceanic Zen</a>
                </small>
            </div>
        
        </footer>
    
        </div>
    </body>
</html>
